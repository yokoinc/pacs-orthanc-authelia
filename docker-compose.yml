# PACS Stack - Orthanc with OHIF Viewer and Authelia Authentication
# Complete medical imaging solution with PostgreSQL, Redis, and Nginx reverse proxy

version: '3.8'

services:
  # =============================================================================
  # DATABASE SERVICES
  # =============================================================================
  
  postgres:
    image: postgres:15
    container_name: pacs-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: orthanc              # Database name for Orthanc PACS
      POSTGRES_USER: orthanc            # Database user
      POSTGRES_PASSWORD: orthanc_password  # Database password (change in production)
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Persistent database storage
    networks:
      - orthanc-network

  redis:
    image: redis:alpine
    container_name: pacs-redis
    restart: unless-stopped
    networks:
      - orthanc-network                 # Session storage for Authelia

  # =============================================================================
  # AUTHENTICATION SERVICES
  # =============================================================================
  
  auth-service:
    image: registry.yokoinc.ovh/pacs-auth-service:1.0.0
    container_name: pacs-auth-service
    restart: unless-stopped
    networks:
      - orthanc-network                 # Custom authentication service

  authelia:
    image: authelia/authelia:4.38.8
    container_name: pacs-authelia
    restart: unless-stopped
    depends_on:
      - redis                           # Requires Redis for session storage
    volumes:
      - ./services/authelia/config:/config  # Configuration and user database
    networks:
      - orthanc-network
    environment:
      - TZ=Europe/Paris                 # Timezone for session management

  # =============================================================================
  # PACS CORE SERVICES
  # =============================================================================
  
  orthanc:
    image: jodogne/orthanc-plugins:latest  # x86_64 only - core PACS server
    container_name: pacs-orthanc
    restart: unless-stopped
    depends_on:
      - postgres                        # Database for DICOM metadata
      - auth-service                    # Authentication service
    volumes:
      - ./services/orthanc/config/orthanc.json:/etc/orthanc/orthanc.json:ro  # PACS configuration
    networks:
      - orthanc-network

  # =============================================================================
  # MEDICAL IMAGING VIEWERS
  # =============================================================================
  
  ohif:
    image: registry.yokoinc.ovh/pacs-ohif:3.10.2
    container_name: pacs-ohif
    restart: unless-stopped
    environment:
      - PUBLIC_URL=/ohif/               # Base URL for OHIF viewer
      - HTTPS=true                      # Enable HTTPS mode
    volumes:
      - ./services/ohif/config/app-config.js:/usr/share/nginx/html/ohif/app-config.js:ro  # OHIF configuration
    networks:
      - orthanc-network

  # =============================================================================
  # REVERSE PROXY & LOAD BALANCER
  # =============================================================================
  
  nginx:
    image: nginx:alpine
    container_name: pacs-nginx
    restart: unless-stopped
    ports:
      - "30080:80"                     # External port for PACS access
    volumes:
      - ./reverse-proxy/nginx.conf:/etc/nginx/nginx.conf:ro           # Main proxy configuration
      - ./reverse-proxy/conf.d:/etc/nginx/conf.d:ro                   # Additional configurations
    depends_on:
      - orthanc                         # PACS server
      - ohif                            # OHIF viewer
    networks:
      - orthanc-network

# =============================================================================
# PERSISTENT STORAGE
# =============================================================================

volumes:
  postgres_data:                        # PostgreSQL database persistence

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

networks:
  orthanc-network:
    driver: bridge                      # Internal network for service communication